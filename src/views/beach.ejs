<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Where's Waldo?</title>
    <link rel="stylesheet" href="styles/main.css" />
  </head>
  <body>
    <div class="header">
      <div class="timer"></div>
      <h2>Find these characters!</h2>
      <div class="group">
        <img src="waldoface.png" width="100" height="100" />
        <div class="col">
          <div class="circle red" id="walc"></div>
          <h3>Waldo</h3>
          <h3 class="colored" id="walt">Not Found</h3>
        </div>
      </div>
      <div class="group">
        <img src="odlawface.webp" width="100" height="100" />
        <div class="col">
          <div class="circle red" id="odlc"></div>
          <h3>Odlaw</h3>
          <h3 class="colored" id="odlt">Not Found</h3>
        </div>
      </div>
      <div class="group">
        <img src="whitebeardface.png" width="100" height="100" />
        <div class="col">
          <div class="circle red" id="wizc"></div>
          <h3>Wizard Whitebeard</h3>
          <h3 class="colored" id="wizt">Not Found</h3>
        </div>
      </div>
    </div>
    <div class="game-wrapper" id="game-wrapper" tabindex="0">
      <div class="clickable">
        <img src="whereswaldo.jpg" class="cable" />
        <div class="canvas"></div>
      </div>
    </div>
    <script>
      let id;
      let date;
      let interval;
      let timer = document.querySelector(".timer");
      async function startup() {
        let request = await fetch(
          "https://wheres-waldo-production.up.railway.app/api/beach",
          {
            mode: "cors",
            method: "POST",
            body: JSON.stringify({
              map: "beach",
            }),
            headers: {
              "Content-type": "application/json; charset=UTF-8",
            },
          },
        )
          .then((response) => response.json())
          .then((response) => {
            if (response.result) {
              id = response.result;
              setTimer();
            } else {
              throw new Error("API fetch error");
            }
          })
          .catch((error) => console.error(error));
      }
      document.addEventListener("DOMContentLoaded", () => {
        startup();
        const gameWrapper = document.getElementById("game-wrapper");
        if (gameWrapper) {
          gameWrapper.focus();
        }
      });
      function setTimer() {
        const start = Date.now();
        function updateTime() {
          let elapsed = Date.now() - start;
          let minutes = Math.floor(elapsed / 60000);
          let seconds = Math.floor((elapsed % 60000) / 1000);
          let milliseconds = Math.floor((elapsed % 1000) / 10);

          minutes = minutes.toString().padStart(2, "0");
          seconds = seconds.toString().padStart(2, "0");
          milliseconds = milliseconds.toString().padStart(2, "0");

          timer.textContent = `${minutes}:${seconds}:${milliseconds}`;
        }
        interval = setInterval(updateTime, 10);
      }
      async function waldoreq(x, y) {
        let request = await fetch(
          "https://wheres-waldo-production.up.railway.app/api/beach/waldo",
          {
            mode: "cors",
            method: "POST",
            body: JSON.stringify({
              id: id,
              x: x,
              y: y,
            }),
            headers: {
              "Content-type": "application/json; charset=UTF-8",
            },
          },
        )
          .then((response) => response.json())
          .then((response) => {
            if (response.result) {
              if (response.result === "Right!") {
                lastGuess = "y";
                return "y";
              } else {
                lastGuess = "n";
                return "n";
              }
            } else {
              throw new Error("API fetch error");
            }
          })
          .catch((error) => console.error(error));
      }
      async function odlawreq(x, y) {
        let request = await fetch(
          "https://wheres-waldo-production.up.railway.app/api/beach/odlaw",
          {
            mode: "cors",
            method: "POST",
            body: JSON.stringify({
              id: id,
              x: x,
              y: y,
            }),
            headers: {
              "Content-type": "application/json; charset=UTF-8",
            },
          },
        )
          .then((response) => response.json())
          .then((response) => {
            if (response.result) {
              if (response.result === "Right!") {
                lastGuess = "y";
                return "y";
              } else {
                lastGuess = "n";
                return "n";
              }
            } else {
              throw new Error("API fetch error");
            }
          })
          .catch((error) => console.error(error));
      }
      async function wizardreq(x, y) {
        let request = await fetch(
          "https://wheres-waldo-production.up.railway.app/api/beach/wizard",
          {
            mode: "cors",
            method: "POST",
            body: JSON.stringify({
              id: id,
              x: x,
              y: y,
            }),
            headers: {
              "Content-type": "application/json; charset=UTF-8",
            },
          },
        )
          .then((response) => response.json())
          .then((response) => {
            if (response.result) {
              if (response.result === "Right!") {
                lastGuess = "y";
                return "y";
              } else {
                lastGuess = "n";
                return "n";
              }
            } else {
              throw new Error("API fetch error");
            }
          })
          .catch((error) => console.error(error));
      }
      let waldoFound = false;
      let odlawFound = false;
      let wizardFound = false;
      let waldosLeft = 3;
      let lastGuess = "";
      async function checkWin() {
        if (waldosLeft === 0) {
          let time;
          cable.removeEventListener("click", circle);
          let div = document.createElement("div");
          let request = await fetch(
            "https://wheres-waldo-production.up.railway.app/api/beach/time",
            {
              mode: "cors",
              method: "POST",
              body: JSON.stringify({
                id: id,
              }),
              headers: {
                "Content-type": "application/json; charset=UTF-8",
              },
            },
          )
            .then((response) => response.json())
            .then((response) => {
              if (response.result) {
                time = new Date(response.result).toISOString().slice(14, -1);
              } else {
                throw new Error("API fetch error");
              }
            })
            .catch((error) => console.error(error));
          clearInterval(interval);
          timer.textContent = time;
          div.textContent =
            "Congratulations, you found all the characters!\nYour time was: " +
            time +
            "!";
          div.classList.add("finaldiv");
          let namestr = "";
          let name = document.createElement("input");
          name.setAttribute("type", "text");
          name.setAttribute("placeholder", "Your name");
          name.addEventListener("change", (e) => {
            namestr = e.currentTarget.value;
          });
          let button = document.createElement("button");
          button.classList.add("finalbutton");
          button.textContent = "Submit";
          button.addEventListener("click", () => {
            submit(namestr);
          });
          async function submit(user) {
            let request = await fetch(
              "https://wheres-waldo-production.up.railway.app/api/beach/score",
              {
                mode: "cors",
                method: "POST",
                body: JSON.stringify({
                  id: id,
                  user: user,
                }),
                headers: {
                  "Content-type": "application/json; charset=UTF-8",
                },
              },
            )
              .then((response) => response.json())
              .then((response) => {
                if (response.result) {
                  if (response.result === "Score submitted") {
                    window.location.replace(
                      "https://wheres-waldo-production.up.railway.app/",
                    );
                  } else {
                    console.log("Score submission error");
                  }
                } else {
                  throw new Error("API fetch error");
                }
              })
              .catch((error) => console.error(error));
          }
          div.appendChild(name);
          div.appendChild(button);
          body.appendChild(div);
        }
      }
      const walc = document.querySelector("#walc");
      const walt = document.querySelector("#walt");
      const odlc = document.querySelector("#odlc");
      const odlt = document.querySelector("#odlt");
      const wizc = document.querySelector("#wizc");
      const wizt = document.querySelector("#wizt");
      function turnCircleGreen(ele) {
        ele.classList.remove("red");
        ele.classList.add("green");
      }
      function turnTextGreen(ele) {
        ele.classList.remove("colored");
        ele.classList.add("colorgr");
        ele.textContent = "Found";
      }
      const cdiv = document.querySelector(".canvas");
      const cable = document.querySelector(".clickable");
      let body = document.querySelector("body");
      cable.addEventListener("click", circle);
      async function circle(e) {
        let canvas = document.createElement("canvas");
        var rect = e.currentTarget.getBoundingClientRect();
        var x = e.clientX - rect.left;
        var y = e.clientY - rect.top;
        function drawCircle(ele, color) {
          const context = ele.getContext("2d");
          const centerX = ele.width / 2;
          const centerY = ele.height / 2;
          const radius = 50;
          context.beginPath();
          context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
          context.lineWidth = 5;
          if (color) {
            context.strokeStyle = color;
          }
          context.stroke();
          ele.setAttribute(
            "style",
            "position: absolute; left: " +
              (x - centerX) +
              "px; top: " +
              (y - centerY) +
              "px;",
          );
        }
        const context = canvas.getContext("2d");
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 50;
        context.beginPath();
        context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
        context.lineWidth = 5;
        context.stroke();
        canvas.setAttribute(
          "style",
          "position: absolute; left: " +
            (x - centerX) +
            "px; top: " +
            (y - centerY) +
            "px;",
        );
        cdiv.appendChild(canvas);
        const div = document.createElement("div");
        div.setAttribute("id", "#onclick");

        if (!waldoFound) {
          const waldo = document.createElement("div");
          const waldopic = document.createElement("img");
          waldopic.setAttribute("src", "waldoface.png");
          waldopic.classList.add("icon");
          waldo.classList.add("waldo");
          const waldotext = document.createElement("div");
          waldotext.textContent = "Waldo";
          waldo.appendChild(waldopic);
          waldo.appendChild(waldotext);
          waldo.addEventListener("click", async () => {
            let getResponse = await waldoreq(x, y);
            let newCanvas = document.createElement("canvas");
            if (lastGuess === "y") {
              drawCircle(newCanvas, "green");
              waldoFound = true;
              waldosLeft--;
              turnCircleGreen(walc);
              turnTextGreen(walt);
              checkWin();
            } else if (lastGuess === "n") {
              drawCircle(newCanvas, "red");
            }
            cdiv.appendChild(newCanvas);
          });
          div.appendChild(waldo);
        }

        if (!odlawFound) {
          const odlaw = document.createElement("div");
          const odlawpic = document.createElement("img");
          odlawpic.setAttribute("src", "odlawface.webp");
          odlawpic.classList.add("icon");
          odlaw.classList.add("odlaw");
          const odlawtext = document.createElement("div");
          odlawtext.textContent = "Odlaw";
          odlaw.appendChild(odlawpic);
          odlaw.appendChild(odlawtext);
          odlaw.addEventListener("click", async () => {
            let getResponse = await odlawreq(x, y);
            let newCanvas = document.createElement("canvas");
            if (lastGuess === "y") {
              drawCircle(newCanvas, "green");
              odlawFound = true;
              waldosLeft--;
              turnCircleGreen(odlc);
              turnTextGreen(odlt);
              checkWin();
            } else if (lastGuess === "n") {
              drawCircle(newCanvas, "red");
            }
            cdiv.appendChild(newCanvas);
          });
          div.appendChild(odlaw);
        }

        if (!wizardFound) {
          const whitebeard = document.createElement("div");
          const whitebeardpic = document.createElement("img");
          whitebeardpic.setAttribute("src", "whitebeardface.png");
          whitebeardpic.classList.add("icon");
          whitebeard.classList.add("whitebeard");
          const whitebeardtext = document.createElement("div");
          whitebeardtext.textContent = "Wizard";
          whitebeard.appendChild(whitebeardpic);
          whitebeard.appendChild(whitebeardtext);
          whitebeard.addEventListener("click", async () => {
            let getResponse = await wizardreq(x, y);
            let newCanvas = document.createElement("canvas");
            if (lastGuess === "y") {
              drawCircle(newCanvas, "green");
              wizardFound = true;
              waldosLeft--;
              turnCircleGreen(wizc);
              turnTextGreen(wizt);
              checkWin();
            } else if (lastGuess === "n") {
              drawCircle(newCanvas, "red");
            }
            cdiv.appendChild(newCanvas);
          });
          div.appendChild(whitebeard);
        }

        let divx =
          y > 1980 && x > 2835
            ? x - 100
            : y > 1980 && x < 55
              ? x + 60
              : y > 1980
                ? x - 40
                : x > 2835
                  ? x - 160
                  : x + 60;
        let divy = y > 1980 ? y - centerY - 150 : y - centerY;
        div.setAttribute(
          "style",
          "width: 100px; height: " +
            waldosLeft * 50 +
            "px; background-color: white; position: absolute; left: " +
            divx +
            "px; top: " +
            divy +
            "px; display: flex; flex-direction: column;",
        );

        cdiv.appendChild(div);
        cable.removeEventListener("click", circle);
        cable.addEventListener("click", uncircle);
        function uncircle() {
          cable.removeEventListener("click", uncircle);
          cdiv.removeChild(div);
          cdiv.removeChild(canvas);
          cable.addEventListener("click", circle);
        }
      }
    </script>
  </body>
</html>
